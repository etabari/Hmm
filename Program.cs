using System;
using System.Collections.Generic;
using System.Text;
using System.Linq;
using System.IO;
using Hmm;
using Hmm.Decoding;
using Hmm.Training;
using Hmm.Model;
using Hmm.Base;

namespace BaseHmm {


    class Program {

        static Random r = new Random();


        static DishonestCasino casino = new DishonestCasino();
        static int[] casinoSeq;
        static string casinoSeqStr = "";
        static IList<HmmState<int>> casinoPi;


        static DnaGenerator dnag = new DnaGenerator();
        static IList<char> dnaSeq;
        static IList<HmmState<char>> dnaPi;


        static IonChannel ionChannel = new IonChannel();
        static double[] ionTrainSet;
        static MarkovChain<double> ionChain;

        static IonChannel2 ionChannel2 = new IonChannel2();

        static void Main(string[] args) {
            //if (args.Length != 3) {
            //    Console.WriteLine("BaseHmm.exe [FILEPATH] 10000 60");
            //    Console.WriteLine("\t 10000 means use the first 10000 number to calculate");
            //    Console.WriteLine("\t 60 means do only 60 training steps over 60 explodes (don't know why)");
            //    Console.WriteLine("\t please give a number for last two arguments");
            //    Console.WriteLine("\t use > to send output to a file if you want");
            //    Console.WriteLine("press a key to exit");
            //    Console.ReadKey();
            //    return;
            //}

            //initiateDataforCasino();

            //TestDecoding();
            //TestSupervisedEstimation();

            //TestBaumWelch();

            //initiateDataForIonChannelTraining(args[0], int.Parse(args[1]));
            //IonChannelBaumWelch(int.Parse(args[2]));

            //initiateDataforDnaG();
            //TestDecodingforDnaG();

            //initiateDataforCasino();
            //TestDecodingforCasino();

            //initiateDataforIonChannel2();
            //TestDecodingforIon2();

            initiateDataforIonChannel();
            TestDecodingforIon();


            Console.WriteLine("Press a key to Exit...");
            // Console.ReadKey();
        }

        private static void initiateDataforCasino() {
            MarkovChain<int> mc = new MarkovChain<int>(casino);
            mc.Generate(30000);
            casinoSeq = mc.Sequence.ToArray();
            casinoPi = mc.TrueStates;
            //sq = new String((from int c in sq_i select c.ToString()[0]).ToArray());
            //sq = "532261666633241541315514513443621124623232614416634545464643325622444552252656141426554615514314141152463426533366156615361666633646415452555644152646251135515125335352431135552566352366626552235442162223653215142163263224543146646635516462546646162111566431515531526154616526245531451436611224264524136656156355126664265266664225656623616142153434644144466621665543335266666666425514545445362362365513654212312423146616634566613624143635541316116436256311536166612152352213535566165416164555564531561666626215251435266566146442236343125332253256642246662512251414132142614236452261635414526625643666261631566566251362631653423411612666361265466622316643252354551154363636524641145166223335562455514355366534361466555616265361641155124636311124552134263655445143531642451155554616162655616646522431363522626626534635665666631122326412634412514136451215434426516623633132162261611254164136264353553544453632212623366566261111341615613615423416126134166152332355565261626664561646616636524164554136161135254661656666662362246563416122266612265656462543136642466561432256326543613155231641362452544145145221323455366366623365663416166165146626566656435313313212144521123553654632123216564462515535143625562342444114226263215516666663453561465631425124621525552311262356455261555344626666666435116661662466266662666651653453322351634654315124461664541525322321144252341655242646111536264411233624666321523221266626665666146266456443563663511341621554266431353622624253113235663166656552226636366626663666266364261514666426145334241354541251166465256625463666465436122666634566262665156234332331314266165654366465636264641614634566613224465534456226344613366655662666266313336616666555212363116161454633521163136664656443615126554626661116112445341453532242242634233322244625155161566513226116434653332165134216644653662424215445656434165665515223412224335142566646666146361464336325412556225363654212333524442456565454666245666666241523413441561623262646656523213146246164452311256615256266446561556356663641665666221661366261462456661512366664141624136525136512535614411613613344114224333524366411665631166564415546263443555166515243666235446655441445212616116152451616234363362665666666322316636656236663665526253532245255326335642156535551224154215316663666336226536452266551564615636135236566434536412645236663265612554345611464561531635635235241626446631216464462264166636113315633252462236644666446646645263663236153663614665222643123131424634626166644225311346366615523111566146541316262664536125636145465336554456533531464451326243115356136226253463421352332341355642624235131141564324651564564556533656236434565523616634616666622436223123366666666266566626261514516612165426661266665666262633224165162354643444366623311342513253341464643213241461323662655666651326666566212211145615466464256624666621555545316656616326622651164364453515324535162623111523233125242512252655334345414363521166656462665451244521531522651526531434426133613616155266626266144665566366511435546444666465613231644246615236666356626623166612153266365166315563466666126463513644133643625566412134662615311124355521266261325161563455233231633541564642363155424234515233514626361432333664654543641141161242145616661626125664633424211415361454412223232464166644321354666415422453625662632441136666636431366661512516653531534343622563566163245666624653563566661654556362666266244446644113433342256543163264111554424641162146121133614451146523656263341311626164661213366546416162666652622456246515255413441235145341555221265155523451561336562454343362526414362362512546153566263614221664111216566662546126661441321136532231656566562665436135335132364466236566666662222463512353624231351626613416662655246231156643122231464166666666446352116232414426555551216361356255561626523253246436623665536514232132643631325651531633233344654662415611612315112542562465666516311263623413455551553543266666266564666631551316564516466456636264215664646656434642414665262224166513451564322531621641666562462224626455435115423121166566166315526211654564144535261453146343251512144616536664426166141212534115653166526145666466561311663223564666121621161165341626136546552323426424334632163236241113355115361342216565213652666345646435634556436666666226235536141123266225611436124553213566245664413424165653656622244123463433646441254666654426444445616123316136666356435451216635431634436616666646642666635626464616626362132246152122412216514516445521133235115424641254334326352663323454323362636265656326166352511126622546625436531436666466355245656626641261426264566545643424326213226534564556666266353152362421143313636444565464123114356353431126216246654363665636554656365655366136526362645336665466616664224352616564632536662252662344263434643354462266532134366146336665115411551466636613624326326661131613556616223441435633142361532436465424422612635126241466466126132564642261324434135246666663433536625212655126161235611121541145521426112345541366335435313443253666656246656666253443664521232223642365445225621642661166621232366363166456636111154134624411631431265261443112411635541234342652145344562545265636466366461462556165625266422136631651214263413454666566446612614235352651241534615666642362666165666665456666664666664323232341664444562446625513365363666666266621614561514665334125354565112643111454236426652214454143225543211625641412634252432216262552664661226353661541162514215616643126546654664663153126212466525321416324363156665666646413145166316532456666262665666626526616221531226316222546664611661514242311646236613235633246666263521126642516131256216626653666566666156616662666216352664532261544123541265666634624522316453366243162524512344665123656161365636666452624555514122621651653364215154516114311245546166163666412362561666326351164534641564132352462263453245364132251142221652162321152345253331636364442443143262266666553636466613545166533434666665661366235615565261612244222326265425411411551462665344152146134311166622516416465535515365536645654126146243211531131616123142651645566653466236266156662666566425554223441222243634511421262551436664235165356555135154316665626335164255333536634325615325426154651666325536336635622134466656641436346531642342242662466526526165651666466624614623666666524223416562636224326631644455616311155314353631146154535314446245323463425316623154155412541235131566666666465666661613623423156522666462121362564446235142455143666665655662666266661665414446533525625561636565556533424111123124152435241213113666241536353555666616564224143422663664222635121456352656345436564661246513655424115412455311666633665261666543536645536345555666626151335614234363525216631422236146456156453436562455516433653132213131661453234444423656666646162335566644453636324136266166163561263151451431642626265256315166461515662516261534262336222636335653542444565666466132244136626623613364352316236415135612523244232321441542364561153522512355136525445441256321145662645666633141543311541415622333332655646562264664446625624626436143433126141411621216651466666556324524242156646541252241643443665354246541132523664625631366536666656252533146542321341546424632232325664625465562644661663355512221616324262356255366616453616666662664364546414323543126233561126331435646433421526465145252533634136621623666442163364254441356366666461146236434446622331331442162356366614644666612324221515541235643243652154555211132616636463363626342643241244354635232126556661416166616166656211535552146646463146611215414413523162232364245234416513663532514432255616611525445256433266642641616664654466662666613333223626226361224666363116366145225152325336615644465662626622142253651565243233521156632445163526354545543414433236411642666666616652545662622626466466634233351316463616446661665666163646615626166663624431646515122165153646466364643656331414611366644235661142151666642366346653363223232566616241226366611326466266612534346525162546442433626616262341335211224646134125115133623132115332664114163432234636564125622526652522443254434354646126266542165424223632565343451243151321656664266663522115666564451621464164544464145612466631266664166462356462665436632616464466631656244211266312623646216452564355424326361163323451554314544663636466561356265332442265461314533311245663632242336666662456626662666616226366622364613633661662541666666336246663251635622361636521213623462656251565232334635664313433136444322446532655233166241315426264244624154136143252454655131353641431224412152666636666356666411531636666613161352161323456154214221213465323232651264415525266466664213626211554416631215113531516516136322516624463426666531635354466326662221542534363263531442352666563521226546526156636115121341231433336365436565346156513252322435441464562233513616111543665652653636654433433644536521433445265544115246543355533144651411255165152421461621231334243612145661562246341435334254123626326626252162426426635312666665631664266611166663253424265336434526413612426135312621533346646336665366216366666213536235634136354663365666114436166341366622116316256634464141532631143144246421523611651453664555353263351162365346516652152315161356666146366666351262154566665652566663661616614366342244214631255253133466312164655446425562514413556543164126635362315363346334142365665365233362645643653166523666441313336466611122132322146211332613124666636446643526232352661632641666565366624516666626612666642126466426234526146323245515216614412651446156515433536442541455452423364221422454441331454423442212264135631366536142233146666461516663353515453614141516666562623666136254236162246253266314631542261165625265336231536412442463566333516351163611233141116644352163625156346651661666545554534151536623566431613666462346463144363664565345116652334624162612213532666666243134655633564231343421666653662666661162361463125164663666515236356166543256514562111212213626555442332233235242636636363366663312166646613225246265661664462145344545331535161241656366634336225664441525333543443251344132324542421666365324463664624516666142451332421331632121665266653665525322416626513553335112544265616463311114355114334642326243665135432536116115241526624246163626366661561626261556434612666645655355644221631114436326353335555645624266643642546131246561113131513656365331224112662613312333313163511533125426162155465366155351133546654611465164426263216312666554562162666243226516314242435236451342146641622616266636656612114561632551253536166666166533264662261234343613456313135556355346661633463241234633333365446543145633532461656251616651416513626324436552556334446242612321666463425642116661366661456666665666636516662366664462666345666666466665463666661642663644666644613656225526133662654334516645515532153543352165232161466646566663662643315665563666562266616411655166316632455135222622562656366664563424135323134641224435561324336311561313462431326661446562444334336645351212326522336116342456155362212321321412336155111544316226666412634534641661324143351525646415255266665616246335136566644653643223552124523362321432135651566662466665663212611432651215616326631336433135315362313653616421333214211536164322646663633362266666316315353414234254611332213364666466664561665311332156444232262311421334512664224416313256111635412146662662631553651164635263616616636356653231111634344351216663355545621164413615466531644241321521364614656532262243445426246452544354536664456451521644436426466666516666533211212211231143625626666634666661262262636341114522442331636262364411266655462636656353354266546526436666616662414466425631316663366365652646516561664266245635165462626416663266361662114156626531645346664642332662641631156316515242421236132121211216356655461565666626632126626664236233622666166666365655133246651514114416462365111453356665136332211624252646112453546262666661654433452431334442363353531342156634333541435451145514564326663445155121132142625135666342316436623416611522661356466636546331214533352261246131564315456165666164364616553461646111646323663344355364551534456324644342444141416136366646666366621662611265646521366261666614662661641436666416253662211361311251211243411413345415555155334266641644231354624361456156466663256216523156352153326221634153354453553235514555121663653142516634263445346523646615236263336346513636422651664656564161562625463632146443542141451112146153316541436426666166253421223445266266664556266613154214611263155131126246163163663664662613654133256166666323163641335634463164111241362231235434254626661116362641164241331542322242554146523545115636612666161233243664234611113252132546164662614666636653266165666625642634315632434366511144163613246566615124161364661624465455653326335425155666661366545454522266443243634235556651335316151461465262444145253415655361666346544513354414131232164635255262411412314546366655442333242636524511262653261215512664266165535131423126224346355142666536335266616565156666366646616154236661614264651154265356666266162556363341125632622116566266445212615516414164131253512535264623222413366413565624662233212653516563651224261156266454426354455256636154661661462636566444264454622511566166434316334326511125151446626663115645433345622436652616155443664526615663144161316644623643616212152523623512646666644664463442546665666666666614421151611333355562624541146416362433251666666365546535665612221165646665666653514331366361146114146652315454323414262133126236626666566166164665646263246356634562364231516566324255445564654563512651611145352354122422115656166621321432353215614624426666654623466632166644241114253435555622434346262312641166624623541312665553456663665466661322626166251562322134244341332111325666644533653665534426666665456661166646246646136442525522131343116331415666562166456363236666322534232433656316414545323525263111535116253625456636265221465426642632415512466566623354624145111433363536112562541125421452436666413441431622214155361241331133422243351556225346642612162235254214133555454444662436136641662122113423536151451614145665623323555112254364333525546154645566543234162625313343663322611266265516215431214666316466466133515222612562425542525236466456522226456566561121664114342416352663553543263652456641425366314336413663245655564114563422666334266416664666251515133264546442653442435161645463536431146663256622144213231113153465162341246322456642211256516615363541116226265263664522366636666664632662246254424111546563266432646342444231442614114656266656664165264143433616621666666536332455362112354631126623336366516221531534452133121221455552666616465454432516454343446232462215224353455463522364163266165211165361465155256551612565632516152513622156616466266666631416666642266134565265564661361142355335621266343666646662433525546154663665452623566561435333146416523121236121221426635615436131211553252423116156434235136234313331615432423652253526656465635242363636466256163165515266365264165211452613434215566314313341663142456666225226256663633226245132641263551563641666264664566666616666554646452324626636461363665662555155446362332154316665666645662664426641625151661665426626363626416621666165266634432262343111215336413131414444665554132446623656556621623661246465666154666636666616162234161662221246145254616663322513662215151635514346136666635324156165351425342166366566462514216146215313145535164131512334222541415231566546541551622425265436363253315566625623622416331451334615122266626662422651263652451266666166565666211111666666664166612636311566441623645645365365521632464123222266665524363643563666361241662362666611516666663666666442561626666645154134235221243241451666165126662366422665661663523663266656646565666563412453366666641525445656316333634666564643641551622664622622133656552214631462315412265125325225316262345461665556656126116453662651235363331345356214135215413511454532635246632646366456566661666623326511234444516265546461641663326666436512563144663665442266443131563365262445152332366636663533661256666615611325623135226651266662564462325613554446651134222163641365466665613642322236464656665143435666233625656154424612125642666152663626365664624266153216626165235214464655222355166161266646163144664625665416533133426216665166656642616664623244216632444512121215356511441653265663356414422162242314216363246666135146313366453551465664462156136632342242646136265626462536466645563122122134623464661626635222432511662445463351623316646446666565266633224126132443413663514425464326434425436656451124121656665651412362665513334255123121311263132655324214216662656666236616666626362356413242564261632324351244325642521365336466664252645321633663566564656542341615646114445366546255664662646662642466666561546566466663613666423556263653646546656455356565466665641456543466625664336466463233661352656353622616626614343462211512234445543113365224665632432635462216651641133111214124622645331556255511441133362114211224312142332231534564165433613233166651662236256554665446115656626162666144532543321145461546534354652666453556663125216146465412463611461614435255662662566636413246263266215666666626335663356622663611434514444154146666666433261611653142616146311333162464355155611145441451662122355452434354126266126666646112535232261554266431414666666164666636656666242164253333563533264256615313644466521663255462265466163366642263522153163161661666511213332645633654234626166646456123664446266321346533463545543554425314115325452565261235411213556664636361231514666614455451164312224265365422213165512345312642323466356362356643623616222626613626651461314533143353253364556311641526456513556116552233126334225511336562622625256624253661561354453312464112636633352453413465663346646656566661666621426314241224666163124616266152142463216646144623166464556244452655454334251626436116466245463636666445226534132644256666626666636254133163145534262264652466666146566461526263546452236165145521436646326666312126326424431654613663356212166666616666251243226235352333423312521432436622646562125663136616636666665365155162262265464312653341451444262254656665531643142416616551552226514121246235454234135525432226263256546332233155446145112321131324625656216652612516124611114135351613222363166465432266664461563362165326264415313351224345665356216616553632645663252656126454616666626264651451361233311643124151536144365316613114662166545213641554315462536666664252634366661516661616421361121635646644145666132266615652313424221214551242666655411134133336136615616521345452112411453561366126653462566266436161314443146315624255356255656444254266453133614445154115454316233361542433516633136464661662633126461211363213563666622641562512653325543362416542215325412346253564522315434512563556211666646666661651661154214633433351662466516123154162523236226152653245662366122121153444331654413245345262214244466261466635215232462614351133321235132132622324663643256656624341561631432534354353626653446155264456666455654566455623545211163646514536153363455236663443325245661434356631446666621643612156343436123312654555236456263511623266436554212114241162231146243351512445366626152664611655243144461111442625213643652666165666666526165124242232461634623454224322531625242356163252612513566261125132314443331143566646166642654166563233665116635223114464234635265634113665365213366546361564266632552414432366661211162366655534616131523661656666364543566415142415231221233633616642526214236256425245624516553222666661616266351366325125151115423614222143254115141621116616611536354434551635334546141135531222666524462531563321366556551126514266123116435666134363452633261556621222416556643625511413146416556414241452234656362136354232326111421166614166553111663466354626243241565265114112215232334544115536366666662166665633562164623566564646166611661132246125436311611266646336564366611256531216315263646446534546121611111366236466312666411253566632121244322314615654146363644522245561262642525252314431613363366211555636664264361661351435634124611256556666151521513266621146236666431466436164612464362666664625666466655662666243632133134251366646166116144611126664662253313345225524562353626666165316135524143166412125224646662365665661663324613254624665653444143453253426452342451643421443225651662345352653146615142216653655266366531611566633556663231635614311363655261513662451261422263611342646653321225213653544451426161664124215266456411413426666626661466661154542146114111112236133261444531122226435436364434526626141442164526611453636566666616665662133436662666615346216663666664116314653264522566666661663144256154432146324166144466436134521644545646625321625141466666665631315541416125114655161255624656122612661666264166324162415646625426466655156616611352524512236624654636656624666265334615344412434353354652532156656664166425666666335412415643214262533156512541462556454555311651231634661444334623535422345566566166546664233646565233636533243253563455446563334116566626366142664316621152326665164451546322521141232614462366653661646366336662335665141464255326616133663521555665252261616366565433462634636464216243416331232316444546611261616662666664323463323461156663166243666634416453253414413636561164664613662666164346133632151666416235132166461563334334234314243652345261656664454451141366663562526666612133624313546543255441632613331541422263514426526536664343325111155651666655466226624321166132622315215612453554126325556221431451266554262643516461436141541326366432223331542214213356446441363665656211413535332315641613643666636656641646613622641223416431565655266235255233432554453362234415621241431234113454525324635214665436616265531444335523524264211152225666266661263616645134626153124112121131245326516666664556566466266334153131241442233214536154222411352325354655526516663534553625565334365616364656136156352665546366626566663462326636212164636312266662646666431435661636132641252443426462263624553642536335221162321622235555353543631614636551651265656666356651366631542663613666663566124363631464515411522534566564342233634666166264134221166623251361225663636326454545223551464326425662366622653426466634663662165341352344542542636666125263154151466566661223336212243352244221531666655222633255152521153566443663134614634225132261441656562666535136662416366364463662626623636666366626255156663644152366266656416464336666446626542453221126663365634422516666636461661566623515442544325212511644562616664662555165416112612246661636456656262142116262361543145656362216416164626631466644656553425534543356556634353612465545621116636541346632366462355635624364442412623216616565661666564413532534256666664245223634621163664133316261341335366663614163433331665626663226662336466665364656665132344611116666546361614162253551555655435525256422351464632313265666666126614441616215664266621666354645561665421452465535256365611214624343213324565316666661424443433236361534511311254346165523643666661646663622335522425666646446435664432646466635641361666436466664515423233533621416432661356523552241135232613315664253334522432116466146421262422164266256116344411155643665145243662125255235346356661653331415262215642616245236151532553412165566512464362546662566656654646456264464366635622213323566546165356611162266412451352613612551123636132355436613566661242633136314523244466663616615656666164634166416625613646446334316611616665463363661126535644362662615165525523461611666161646443165666666664533666664166661636355266366362266556662633454116516632254425265661464213563312225111112254563225324666466646641566652146213665356331562534354622142622555111231662662666621112655666663525221156161661655226315546463135243554346141564556514664315332625522665361662524662443643365141614136556666625216414261166414326313565161352246342244645425516121522115135143335443341115336366532413516241363362646261466661441634654154134254662126312352536231113423536152365622621553546165333223554264644333132243251231342641256365366115225352224266441433431233213561666641532664666245424264145265551252534151133342461234133342612336321533164111424153151663636631613626644546666664261312135464363422315632245141514453422566621323661641165155364366244665313345146631224661634155232661624246624666263126162426232613321564551324653636442646222355364643662526455125336346345162516125146616666235644544236622341111421645226221463364541366661642656165456161133441366216224356153512265143532633513664146655566462326643666661566434466613455626633361142646321661213426666663356453563452461162526161115155635321665431324456643666146461422466511665246136236562452652231661364665116231363665416124163616221441613334451663346141644451255345256464644141556643665124242253623266316313456223634113653236661113433524331236452324616555451642661616353622443635316362566456464226642113546323654152325553653353456612563326642155325512416151451663351356251122433462433126515415412236555652545356122345562331334624164552442251511622133225531566565561123661124534331355121215252516245411135524325563261622321223421135464213433233136565253611544123124311556661151626663563561635115632561115236162422365266135145323225151315523261525645536265436216662155642116514666266621115246551622331352515653163541152235426552662441361332336325361654412224621535111561523662134641562414361566642514131155664215512555255543662433563114416646666616531421316615321565222355633215416162432431113614364434212522121442341162346554334543636116463116526145644646225256233263666666313155652543322325414521236656664521365362646614356416626166556265646646663266514666216266634666316443545466346161236655452634433251151422165234232143241526632445221535336266426416515661463566632466621231422536662264643466645345613633114151345222153633656554514341354314432614633256165615242655141242621312246241116642316333542353555433344256613636634254451632343533154226666152366166466644656666554166666255361515555534216666444616361666666146661666666663333662333666666322432123366561615435236441646652611564556565466131626624423211455456625516515625443142141214564661463234653332621663221333326525231432133526656266662263632666356666631666113215613115665656566316663211362645556154365256466633226532545641635511251335453454123633413421466143533531316366636153536636634233364566123316315545321264313111243564643551222263152445614252665166666666366624646624421236166662646664666626431416324544254461314432625165356265152665415243242146455212115425332665641662466162366516154123363621444534213226123545464364655163566231613662264666466252366612433154323555123623355524666146366616524431122564544331366663566666626666661665163666664136111264634411555263454535352441464456234644136155332651466622163462563165366416535152421625544623664346663541343513466646664235663615435433465245514412165536242135554344152521251422363123463464652546416412452521632124221114351551556432545152266126353242143641615415666215154422656663416613263366616665666116364244515362661632662366432666316556464635444251431634544526631236616246151313431624653614536552445212313662622635424636554566515454665624136651536265116261266425636666654365445542141446352424444512113644645555231262643164336166646636556323656626661666651622423166646616533666546565416445146622615311245146155564125666134456666565615666253624532346453652153612165533511641625333111626613343634666466231366326416534623656412246526165615555155656624223565466226153442165633425146236231132466113662566466425353216614366235656113516444524354634645626415651126555223132153234644442345636655332443662666635163655666142613541265211124566622346144362666265661266226666662121312111331426664361612212326264611126424322145161166226252434424621222626465634553245246421242432635122522661212351161366661566436644441336616366366656263436133664662613666631631221124665524345511154426322455636524646222663623154621265536361441361665613312356423616156165126564452131212435361531141331243665661154265243635655115565625456626151666666665265411646662166465632146625111531466515663655525114235646545462632216436366266165313253342226335113241542241551556662166423622556153366165351566254646641363644362554563646555114152151112354165536656146446135265144346626641166316266245464464443652666256616136166666264213261531611624651341546516435226521133355225512123242646116243153623511465553366163326336234421421261443361356666622423351562615526334442154152165461262422312265511552344651336631265332662463456144466413366666624452145623361132545652611416222415626133666665125153135641463656635665646616325166235643312644436236424563125214165653366331345324443216664162466135136435566461454314456126654613536445546266666563663664216363256535641666444562463153514353566666613444346113665656613356135633636332451651465656544226116656262513364325462263455342123224525514261155636166145223111516416153424226543521663422465235526416226363556111544131316341622125563451542614636151334461652543163131312666636453463225212412361662616366634166244462542513316226661466162322346116626612165533666651634455646236213144425553261664666136623664546415661626164361121663622541325251643112235116666411626626666666666635154234246266126656232313114442165632351465555143316512246613665343441133645435211563666165661645266643666262641636143121643662633233113166666646565144633656542623664245646156615453245225613223123222321262466122164212513426646641651566135315462565423341436152624364461566335261236566342661512433513311425623321562653164651625465432211142433164551422431663611532446532256262436641165152235166252235613251511514626661132651432661666666664553441663164654651164145661613664532433343235542666314545615446622246514646561366663163656466541635212342465433312311345322452434214641563655642232661664161665635434635135516123346333616666464351442251556165122222624535223232361666461515666552266536666661615335564413623661666664363346666256613225232534216322141156414612633551554511323121223431253645431666561356231136316666166565461152562535162544262664666326622324161132415353554236231661352411315445313356666111363213444315452364626636236336432262433423564116526126344642232263663552616346163122414131652212165225455653666314646523156655623266532464466436342644464664315521142554163235155455212365146266566111126661612626666412565134356444612153554151526646546142263524666442132212234224346336226443243662631433454434515324446645663614412616663652255553321631141635146426264664131316246543614166313165624654156621422531256622532125325251531665465515516665466511";
            //sq_i = (from char c in sq select int.Parse(c.ToString())).ToArray();
        }

        private static void initiateDataforDnaG() {
            MarkovChain<char> mc = new MarkovChain<char>(dnag);
            mc.Generate(10000);
            dnaSeq = mc.Sequence;
            dnaPi = mc.TrueStates;
        }


        private static void initiateDataForIonChannelTraining(string file, int linesToRead = 10000) {
            if (linesToRead > 1000000)
                linesToRead = 1000000;
            Console.WriteLine("Loading file: " + linesToRead + " records");
            ionTrainSet = new double[linesToRead];

            int lines = 0;

            StreamReader sr = File.OpenText(file);
            string line = sr.ReadLine();
            while (lines < linesToRead) {
                line = sr.ReadLine();
                if (line == null)
                    break;
                ionTrainSet[lines] = double.Parse(line.Split('\t')[1]);
                lines++;
            }
            sr.Close();
            Console.WriteLine("File loaded");
        }

        private static void initiateDataforIonChannel() {
            ionChain = new MarkovChain<double>(ionChannel);
            ionChain.Generate(100000);

        }

        private static void initiateDataforIonChannel2() {
            ionChain = new MarkovChain<double>(ionChannel2);
            ionChain.Generate(50000);

        }

        private static void IonChannelBaumWelch(int a) {
            FBDecoding<double> fb = new FBDecoding<double>(ionChannel);
            fb.Decode(ionTrainSet);

            PrintMatrices(ionChannel);
            Console.WriteLine(fb.LogPx);

            Console.WriteLine("=====================Train===============");
            BaumWelchContinuous bwt = new BaumWelchContinuous(ionChannel);
            bwt.AddTrainSet(ionTrainSet);
            for (int i = 1; i < a / 10; i++) {
                bwt.Train(10);
                Console.WriteLine("\n------------Iteration " + i * 10);
                PrintMatrices(ionChannel);
                Console.WriteLine(bwt.PValueLog);
            }
        }

        private static void TestBaumWelch() {
            FBDecoding<int> fb = new FBDecoding<int>(casino);
            fb.Decode(casinoSeq);

            PrintMatrices(casino);
            Console.WriteLine(fb.LogPx);
            Console.WriteLine("=====================Scramble===============");
            foreach (var state in casino.States) {
                double[] e = createArraySumsToOne(casino.Symbols.Count);
                for (int i = 0; i < casino.Symbols.Count; i++)
                    ((DiscreteStateEmissions<int>)casino.Emissions[state]).setProbability(casino.Symbols[i], e[i]);
                if (!casino.Emissions[state].IsCorrect())
                    Console.WriteLine("Bad Emission Parameters for " + state);
            }

            foreach (var s in casino.States)
                if (!(s is IHmmEndState)) {
                    double[] e = createArraySumsToOne(casino.States.Count - 1);
                    for (int i = 0; i < casino.States.Count - 1; i++)
                        casino.Transitions[s].setProbability(casino.States[i], e[i] - .00005);
                    if (!casino.Transitions[s].IsCorrect())
                        Console.WriteLine("Bad Transition Parameters from " + s);
                }
            //casino.Transitions[DishonestCasino.Fair].setProbability(DishonestCasino.Fair, 0.2576);
            //casino.Transitions[DishonestCasino.Fair].setProbability(DishonestCasino.Loaded, 0.7424);
            //casino.Transitions[DishonestCasino.Loaded].setProbability(DishonestCasino.Fair, 0.0161  );
            //casino.Transitions[DishonestCasino.Fair].setProbability(DishonestCasino.Loaded, 0.9839);

            PrintMatrices(casino);

            fb = new FBDecoding<int>(casino);
            fb.Decode(casinoSeq);
            Console.WriteLine(fb.LogPx);
            Console.WriteLine("=====================Train===============");
            BaumWelchDiscrete<int> bwt = new BaumWelchDiscrete<int>(casino);
            bwt.AddTrainSet(casinoSeq);
            for (int i = 1; i < 100; i++) {
                bwt.Train(10);
                Console.WriteLine("\n------------Iteration " + i * 10);
                PrintMatrices(casino);
                Console.WriteLine(bwt.PValueLog);
            }
        }

        private static double[] createArraySumsToOne(int len) {
            double[] arr = new double[len];
            double sum = 0;
            for (int i = 0; i < arr.Length; i++) {
                arr[i] = r.NextDouble();
                sum += arr[i];
            }
            for (int i = 0; i < arr.Length; i++)
                arr[i] /= sum;
            return arr;
        }

        private static void Test2() {
            //PrintMatrices();
            //foreach (var a in mc.Sequence)
            //    Console.Write(a);
            //Console.WriteLine();
            //foreach (var a in mc.TrueStates)
            //    Console.Write(a);

            //foreach (var state in casino.States) {
            //    Console.WriteLine(state);
            //    foreach (var item in vit.LogPobabilities[state]) {
            //        Console.WriteLine(Math.Exp(item));
            //    }
            //}

            //foreach (var a in vit.PredictedStatePath)
            //    Console.Write(a);


            //var data = casino.Emissions[casino.States[0]].data;

            //foreach (var am in from s in casino.Symbols orderby s select s)
            //    Console.WriteLine(am.ToString() + " --> " + casino.Emissions[casino.States[0]][am]);

            //for (double prob = 0.0; prob <= 1.1; prob += .05) {
            //    Console.WriteLine("=================" + prob);
            //    var a = from e in data
            //            where e.Value.Probability > 0.0 && e.Value.Cdf >= prob
            //            orderby e.Key
            //            select e.Key;

            //    if (a.Count() > 0)
            //        Console.WriteLine(a.First());
            //    else {
            //        a = from e in data
            //            where e.Value.Probability > 0.0
            //            orderby e.Key descending
            //            select e.Key;

            //        Console.WriteLine("==="+a.First());
            //    }
            //}
        }

        private static void TestSupervisedEstimation() {

            PrintMatrices(casino);
            MarkovChain<int> mc = new MarkovChain<int>(casino);

            //string sq = "221264643165244666254366666551662666664645332543133566666165366466666555235665514444426153656231";
            //string pi = "FFFFFFFFFFFFFFFFFFFFFFLLLLLLLLLLLLLLLLLLLLLLFFFFFFFFFFFFLLLLLLLLLLLLLLLLLLLFFFFFFFFFFFFFFFFFFFFF";



            int[] fcount = new int[7];
            int[] lcount = new int[7];
            for (int i = 0; i < casinoSeqStr.Length; i++) {
                if (casinoPi[i] == DishonestCasino.Fair)
                    fcount[int.Parse(casinoSeqStr[i].ToString())]++;
                else
                    lcount[int.Parse(casinoSeqStr[i].ToString())]++;

            }
            int ff = 0, fl = 0, ll = 0, lf = 0;
            for (int i = 0; i < casinoSeqStr.Length - 1; i++) {
                if (casinoPi[i] == DishonestCasino.Fair) {
                    if (casinoPi[i + 1] == DishonestCasino.Fair)
                        ff++;
                    else fl++;
                }


                else {
                    if (casinoPi[i + 1] == DishonestCasino.Fair)
                        lf++;
                    else ll++;
                }


            }
            Console.WriteLine("FCOUNT");
            foreach (var a in fcount)
                Console.WriteLine(1.0 * a / fcount.Sum());
            Console.WriteLine("LCOUNT");
            foreach (var a in lcount)
                Console.WriteLine(1.0 * a / lcount.Sum());
            Console.WriteLine(casinoSeqStr.Length);
            Console.WriteLine("{0},{1} ... {2} {3}", 1.0 * ff / (ff + fl), 1.0 * fl / (ff + fl), 1.0 * ll / (lf + ll), 1.0 * lf / (lf + ll));

            Console.WriteLine("{0},{1} ... {2} {3}", ff, fl, ll, lf);
        }


        public static void TestDecodingforCasino() {
            PrintMatrices(casino);
            //MarkovChane<int> mc = new MarkovChane<int>(casino);

            //sq_i = new int[] { 6,3,4,5,6,6,5 };
            ViterbiDecoding<int> vit = new ViterbiDecoding<int>(casino);
            vit.Decode(casinoSeq);

            FBDecoding<int> fb = new FBDecoding<int>(casino);

            fb.Decode(casinoSeq);


            StreamWriter swriter;
            swriter = File.CreateText("D:\\Temp\\MyTextFile2DC.txt");
            swriter.WriteLine("i,pi,Obs,vit,Posterior1,Posterior2");
            for (int i = 0; i < casinoSeq.Length; i++) {
                swriter.WriteLine(i.ToString() + "," + casinoPi[i] + "," +
                    casinoSeq[i] + "," + fb.PredictedStatePath[i] + "," +
                    Math.Exp(fb.LogPobabilities[casino.States[0]][i]).ToString() + "," +
                    Math.Exp(fb.LogPobabilities[casino.States[1]][i]).ToString()
                    );
            }
            swriter.Close();
        }


        public static void TestDecodingforDnaG() {
            PrintMatrices(dnag);

            ViterbiDecoding<char> vit = new ViterbiDecoding<char>(dnag);
            vit.Decode(dnaSeq);


            FBDecoding<char> fb = new FBDecoding<char>(dnag);

            fb.Decode(dnaSeq);


            StreamWriter swriter;
            swriter = File.CreateText("D:\\Temp\\MyTextFile2DNA.txt");
            swriter.WriteLine("i,pi,Obs,vit,Posterior1,Posterior2,Posterior3");
            for (int i = 0; i < dnaSeq.Count; i++) {
                swriter.WriteLine(i.ToString() + "," + dnaPi[i] + "," +
                    dnaSeq[i] + "," + fb.PredictedStatePath[i] + "," +
                    Math.Exp(fb.LogPobabilities[dnag.States[0]][i]).ToString() + "," +
                    Math.Exp(fb.LogPobabilities[dnag.States[1]][i]).ToString() + "," +
                    Math.Exp(fb.LogPobabilities[dnag.States[2]][i]).ToString()
                    );
            }
            swriter.Close();
        }

        public static void TestDecodingforIon2() {
            PrintMatrices(ionChannel2);

            //ViterbiDecoding<double> vit = new ViterbiDecoding<double>(ionChannel2);
            //vit.Decode(ionChain.Sequence);


            FBDecoding<double> fb = new FBDecoding<double>(ionChannel2);

            fb.Decode(IonChannel2Data.sampleData);

            Console.WriteLine(fb.LogPx);
            Console.WriteLine(Math.Exp(fb.LogPx));

            StreamWriter swriter;
            swriter = File.CreateText("D:\\Temp\\MyTextFile2Ion2.txt");
            swriter.WriteLine("i,pi,Obs,vit,C,O");
            for (int i = 0; i < IonChannel2Data.sampleData.Length; i++) {
                swriter.WriteLine(i.ToString() + "," + IonChannel2Data.truePath[i] + "," +
                    IonChannel2Data.sampleData[i] + "," + fb.PredictedStatePath[i] + "," +
                    Math.Exp(fb.LogPobabilities[ionChannel2.States[0]][i]).ToString() + "," +
                    Math.Exp(fb.LogPobabilities[ionChannel2.States[1]][i]).ToString()
                    );
            }
            swriter.Close();
        }


        public static void TestDecodingforIon() {
            PrintMatrices(ionChannel);

            ViterbiDecoding<double> vit = new ViterbiDecoding<double>(ionChannel);
            vit.Decode(ionChain.Sequence);


            FBDecoding<double> fb = new FBDecoding<double>(ionChannel);

            fb.Decode(ionChain.Sequence);


            StreamWriter swriter;
            swriter = File.CreateText("D:\\Temp\\MyTextFile2Ion.txt");
            swriter.WriteLine("i,pi,pi.hat,Obs,Close,B,P,O,Q,Burst,Open");
            for (int i = 0; i < ionChain.Sequence.Count; i++) {
                swriter.WriteLine(i.ToString() + "," + 
                    ionChain.TrueStates[i] + "," +
                    fb.PredictedStatePath[i] + "," +
                    ionChain.Sequence[i] + "," + 
                    Math.Exp(fb.LogPobabilities[ionChannel.States[0]][i]).ToString() + "," +
                    Math.Exp(fb.LogPobabilities[ionChannel.States[1]][i]).ToString() + "," +
                    Math.Exp(fb.LogPobabilities[ionChannel.States[2]][i]).ToString() + "," +
                    Math.Exp(fb.LogPobabilities[ionChannel.States[3]][i]).ToString() + "," +
                    Math.Exp(fb.LogPobabilities[ionChannel.States[4]][i]).ToString() + "," +


                    (Math.Exp(fb.LogPobabilities[ionChannel.States[1]][i]) +
                     Math.Exp(fb.LogPobabilities[ionChannel.States[2]][i])).ToString() + "," +

                    (Math.Exp(fb.LogPobabilities[ionChannel.States[3]][i]) +
                     Math.Exp(fb.LogPobabilities[ionChannel.States[4]][i])).ToString()

                    );
            }
            swriter.Close();

            swriter = File.CreateText("D:\\Temp\\MyTextFile2Ion_forward.txt");
            swriter.WriteLine("i,pi,Obs,vit,C,P,O,Q");
            for (int i = 0; i < ionChain.Sequence.Count; i++) {
                swriter.WriteLine(i.ToString() + "," + ionChain.TrueStates[i] + "," +
                    ionChain.Sequence[i] + "," + fb.PredictedStatePath[i] + "," +
                    Math.Exp(fb.LogForward[ionChannel.States[0]][i]).ToString() + "," +
                    Math.Exp(fb.LogForward[ionChannel.States[1]][i]).ToString() + "," +
                    Math.Exp(fb.LogForward[ionChannel.States[2]][i]).ToString() + "," +
                    Math.Exp(fb.LogForward[ionChannel.States[3]][i]).ToString() + "," +
                    Math.Exp(fb.LogForward[ionChannel.States[4]][i]).ToString()
                    );
            }
            swriter.Close();
        }




        private static void PrintMatrices<T>(BaseMarkovModel<T> model) where T : IEquatable<T>, IComparable<T> {
            Console.WriteLine("Transition Probabilities:");
            Console.WriteLine(model.Transitions);
            Console.WriteLine("\nEmission Probabilities:");
            Console.WriteLine(model.Emissions);
            Console.WriteLine();
        }


    }
}

